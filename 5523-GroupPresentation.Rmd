---
title: "Presentation Ninja"
subtitle: "&#x2694;&#xFE0F; xaringan +<br/>&#x1F60E; xaringanthemer"  
author: 
  - "Yihui Xie"
  - "Garrick Aden-Buie"
date: '`r Sys.Date()`'
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: xaringan-themer.css
    seal: false
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
library(xaringanthemer)
library(xaringanExtra)
library(readr)
library(tidyverse)
library(knitr)
library(kableExtra)
library(sugrrants) # create calendar
library(leaflet)
library(lubridate)
library(ggthemes)
library(DT)
library(ggcal)
```


```{r xaringan-themer, include=FALSE, warning=FALSE}
style_solarized_light()
```

background-image: url(https://i.insider.com/5c17d38801c0ea08470c8fb2?width=700&format=jpeg&auto=webp)

# Group member

### Yiwen Jiang (yjia0021) 
### Yuheng Cui (ycui0008)

.footnote[
Image source: Insider https://i.insider.com/5c17d38801c0ea08470c8fb2?width=700&format=jpeg&auto=webp
]

---

# Topic

### How does relative humidity in Melbourne change throughout the day and year? When is it most uncomfortable to walk around the city?



---

#### Data

```{r read-data, echo = FALSE, message=FALSE,warning=FALSE}
climate_locations <- read_csv(here::here("data/Microclimate_Sensor_Locations.csv"))
climate_readings <- read_csv(here::here("data/Microclimate_Sensor_Readings.csv"))
```

```{r use-panel,include=FALSE}
use_panelset()
```

.panelset[
.panel[.panel-name[climate_locations.csv]
```{r view-location, echo = FALSE}
climate_locations %>% 
  kable() %>% 
  kable_material(c("striped", "hover"), font_size = 9, full_width = F)
```

This dataset is small and only has 5 rows and 6 columns.


]

.panel[.panel-name[climate_readings.csv]
```{r view-readings, echo = FALSE}
climate_readings %>% 
  head() %>% 
  kable() %>% 
  kable_material(c("striped", "hover"), font_size = 9, full_width = F)
```

This dataset has `r nrow(climate_readings)` rows and `r ncol(climate_readings)` columns.

* `value`: Value of reading
* `type`: type of sensor
]
.panel[.panel-name[What we need]
```{r readings-type, echo=FALSE}
data.frame(type = c("TPH.RH", "TPH.RH-EPA-1h"),
           measures = c("Relative humidity (RH) every 15 mins",
                        "Relative humidity (RH) every 1 hour"),
           range = rep("1 - 100", 2),
           unit = rep("%", 2)
           ) %>% 
  kbl() %>%
  kable_paper(full_width = F) %>%
  column_spec(1, bold = T, border_right = T) %>%
  column_spec(2, background = "yellow")

```

**TPH**: Temperature, Pressure and Humidity

##### What is Relative Humidity?
[....]

About `climate_readings` data: There may be situations where no readings are reported for all sensors or only some readings are reported at a particular site. 



]

]

.footnote[

source from [Microclimate Sensor Readings](https://data.melbourne.vic.gov.au/Environment/Microclimate-Sensor-Readings/u4vh-84j8?src=featured_banner) and [Microclimate Sensor Locations](https://data.melbourne.vic.gov.au/Environment/Microclimate-Sensor-Locations/irqv-hjr4)]


---

#### Overview of the sensors' locations

```{r sensor-location, echo = FALSE, cache=TRUE}
leaflet(climate_locations) %>%
  addTiles() %>%
  addMarkers(
    lng = ~longitude,
    lat = ~latitude,
    popup = ~description,
    label = ~site_id,
    labelOptions = labelOptions(
      direction = "bottom",
      noHide = T,
      style = list(
        "color" = "black",
        "font-family" = "serif",
        "font-style" = "italic",
        "box-shadow" = "3px 3px rgba(0,0,0,0.25)",
        "font-size" = "12px",
        "border-color" = "rgba(0,0,0,0.5)"
      )
    )
  ) 
```





```{r daily_rh3, echo=FALSE,warning=FALSE,message=FALSE,cache=TRUE}

df1 <- climate_readings %>% 
#   mutate(date_time = parse_date_time(local_time, '%y%m%d %I:%M:%S %p')) %>%
#   separate(date_time, into = c("date", "time"), " ")
# 
# climate_readings_hrly <- df1 %>% 
  filter(type %in% c("TPH.RH", "TPH.RH-EPA-1h")) %>%    
  # mutate(date = as.Date(date, format = "%Y-%m-%d"),
  #        time = hms::as_hms(time)) %>%
  # mutate(time = hour(time),
  #        time = as.double(time)) 
  mutate(
    date_time = as.POSIXlt(parse_date_time(local_time, '%y%m%d %I:%M:%S %p')),
    time = floor_date(date_time, "15 mins"),
    time = format(time, "%H:%M"
    )
)


climate_readings_hrly <- df1 %>%
  separate(date_time, into = "date", " ") %>% 
  separate(time, into = "hour", ":") %>% 
  mutate(date = as.Date(date, format = "%Y-%m-%d"),
         time = as.double(hour))
```

---

#### Average RH throughout year (by `site_id`)


```{r,echo = FALSE, message=FALSE, warning=FALSE}
df3 <- climate_readings_hrly %>% 
  group_by(date, site_id) %>% 
  summarise(value_mean = mean(value)) %>% 
  ungroup() %>%
  mutate(comfort = case_when(
    value_mean >60 ~ "wet",
    value_mean > 30 & value_mean < 60 ~ "comfort", 
    TRUE ~ "dry"
    ))

df3$comfort <- factor(df3$comfort, levels = c("wet", "comfort", "dry"), labels = c("wet", "comfort", "dry"))

df2 <- df3 %>% 
  mutate(month = month(date)) %>% 
  mutate(season = case_when(
    month %in% c(9:11) ~ "spring",
    month %in% c(12,1,2) ~ "summer",
    month %in% c(3:5) ~ "autumn",
    TRUE ~ "winter"
  ))

df2$season <- factor(df2$season, levels=c("spring", "summer", "autumn", "winter"), labels=c("spring", "summer", "autumn", "winter"))


df2 %>% 
  # filter(site_id == "arc1045") %>%
  # group_by(date, site_id) %>% 
  # summarise(value_mean = mean(value)) %>% 
  # ungroup() %>% 
  ggplot(aes(x = date, y = value_mean)) +
  geom_point(aes(color = season)) +
  geom_rug(sides = "l", alpha = 0.2)+
  # geom_line()+
  scale_x_date(date_breaks = "1 month")+
  geom_vline(xintercept = as.Date("2020-01-01"), size = 1, color = "red")+
  geom_hline(yintercept = c(30, 60), color = "green", size = 1)+
  annotate("text", x = as.Date("2020-05-01"), y = 40, label = "Comfort Zone (between 30-60)", color = "Black", size = 3)+
  annotate("label", x = as.Date("2020-01-01"), y = 90, label = "2020-01-01", color = "red", size = 3)+
  labs(y = "RH (%)", x = "", title = "Daily Relative Humidity", subtitle = "RH range is from 1 to 100") +
  geom_rect(ymin =30, ymax = 60, xmin = as.Date("2019-11-01", format = "%Y-%m-%d"), xmax = as.Date("2020-11-20", format = "%Y-%m-%d"), fill = "#5dfc87", alpha = 0.005)+
  geom_smooth(span = 0.1)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  facet_wrap(~ site_id, ncol = 2)


```


---

#### Calender heatmap

.panelset[

.panel[.panel-name[arc1047]
```{r heatmap2, echo = FALSE}
dates <- df2 %>% 
  filter(site_id == "arc1047") %>% 
  pull(date)

value <- df2 %>% 
  filter(site_id == "arc1047") %>% 
  pull(comfort)

ggcal(dates = dates, fills = value)+
  scale_fill_manual(name ="value", 
                    values = c("steelblue",
                               "forestgreen",
                               "red"))
```
]

.panel[.panel-name[arc1046]
```{r heatmap3, echo = FALSE}
dates <- df2 %>% 
  filter(site_id == "arc1046") %>% 
  pull(date)

value <- df2 %>% 
  filter(site_id == "arc1046") %>% 
  pull(comfort)

ggcal(dates = dates, fills = value)+
  scale_fill_manual(name ="value", 
                    values = c("steelblue",
                               "forestgreen",
                               "red"))
```
]

.panel[.panel-name[arc1048]
```{r heatmap4, echo = FALSE}
dates <- df2 %>% 
  filter(site_id == "arc1048") %>% 
  pull(date)

value <- df2 %>% 
  filter(site_id == "arc1048") %>% 
  pull(comfort)

ggcal(dates = dates, fills = value)+
  scale_fill_manual(name ="value", 
                    values = c("steelblue",
                               "forestgreen",
                               "red"))
```
]


.panel[.panel-name[arc1050]
```{r heatmap5, echo = FALSE}
dates <- df2 %>% 
  filter(site_id == "arc1050") %>% 
  pull(date)

value <- df2 %>% 
  filter(site_id == "arc1050") %>% 
  pull(comfort)

ggcal(dates = dates, fills = value)+
  scale_fill_manual(name ="value", 
                    values = c("steelblue",
                               "forestgreen",
                               "red"))
```
]

.panel[.panel-name[arc1045]

```{r heatmap1, echo = FALSE}
dates <- df2 %>% 
  filter(site_id == "arc1045") %>% 
  pull(date)

value <- df2 %>% 
  filter(site_id == "arc1045") %>% 
  pull(comfort)

ggcal(dates = dates, fills = value) +
  scale_fill_manual(name ="value", 
                    values = c("steelblue",
                               "forestgreen",
                               "red"))
```

]

]






---

#### Four seasons in Melbourne --- most comfort and most uncomfort seasons


```{r comfort_season, echo = FALSE}
df4 <- df2 %>% 
  group_by(comfort, season) %>% 
  count(comfort) %>% 
  ungroup() 


wet <- max(filter(df4, comfort == "wet")$n)
dry <- max(filter(df4, comfort == "dry")$n)
comfort <- max(filter(df4, comfort == "comfort")$n)

dt1 <- df4 %>% 
  pivot_wider(names_from = "comfort", values_from = n) %>% 
  mutate(dry = str_replace_na(dry, 0)) %>% 
  datatable(rownames = FALSE, options = list(dom = 't')) %>% 
  formatStyle(columns = "wet", 
              background = styleEqual(wet, "lightblue")) %>%
  formatStyle(columns = "comfort", 
              background = styleEqual(comfort, "lightgreen")) %>% 
  formatStyle(columns = "dry", 
              background = styleEqual(dry, "orange"))

dt1 %>% widgetframe::frameWidget(height = 200)
```








---

#### Comfortable or not by each site

```{r yes-no-map, echo=FALSE}
df3 <- df2 %>% 
  group_by(site_id, comfort) %>% 
  count(comfort) %>% 
  pivot_wider(names_from = "comfort",
              values_from = "n") 
df3$dry <- df3$dry %>%  replace_na(0)
df3 <- df3 %>% 
  left_join(climate_locations, by = "site_id") 


leaflet(df3) %>% 
  addTiles() %>% 
  addMarkers(lng = ~longitude,
             lat = ~latitude,
             popup = paste("Site id:", df3$site_id, "<br>",
                           "Location", df3$description, "<br>",
                           "Wet records:", df3$wet, "<br>",
                           "Comfort records:", df3$comfort, "<br>",
                           "Dry records:", df3$dry))
```


---




